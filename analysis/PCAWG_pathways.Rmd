---
title: "Signalling pathways in PCAWG"
output:
  html_document:
    df_print: paged
---

```{r}
knitr::opts_chunk$set(comment = '', fig.width = 6, 
                      fig.height = 6, echo = FALSE, 
                      warning = FALSE)
```


```{r load-packages}
library(here)
fig.dir = here("figures/pathways_analysis")

if(! file.exists(fig.dir)){
    dir.create(fig.dir, recursive = TRUE)
}

source(here("R/load_packages.R"))
```

```{r loading}
mutated.pathways.tissues = readRDS(file = here("data/RDS/PCAWG/10_onco_pathways",
                                              "pcawg_pathways.RDS"))

PCAWG.full.subset.ann.pathways = readRDS(file = here("data/RDS/PCAWG/10_onco_pathways",
                                              "PCAWG.full.subset.ann.pathways.RDS"))
```

### Heatmap of cancer types and pathways

```{r pathway-summary-heatmap}
pathway.summaries.by.tissues = mutated.pathways.tissues %>% 
    mutate(across(`Cell Cycle`:Telomeric, ~as.numeric(.x > 0))) %>% 
    group_by(Cancer.Types) %>% 
    summarize(across(`Cell Cycle`:Telomeric, sum))

pcawg.pathway.summaries.gg = pathway.summaries.by.tissues  %>% 
    gather("Pathway", "Activity", -Cancer.Types) %>% 
    group_by(Cancer.Types, Pathway) %>% 
    summarise(total = sum(Activity))

path.order = pcawg.pathway.summaries.gg %>% 
    dplyr::select(Pathway, total) %>% 
    group_by(Pathway) %>% 
    summarise(ss = sum(total)) %>% 
    arrange(desc(ss)) %>% 
    pull(Pathway)

pcawg.pathways.plot = pcawg.pathway.summaries.gg %>% rename(Counts = total) %>% 
    mutate(Pathway = factor(Pathway, levels = path.order)) %>% 
    
    ggplot(aes(x = Pathway, y = Cancer.Types) ) + 
        geom_tile(aes(fill = Counts), color = "gray80") +
        geom_text(aes(label = Counts), size = 3.4) + 
    #scale_fill_viridis(option = "plasma")
    scale_fill_gradient(low = "aliceblue", high = "orange") + 
    theme_minimal(base_size = 14) + 
    xlab("") + ylab("") + 
    ggtitle("Pathway alterations across tissues",) +
    theme(panel.grid = element_blank(),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          legend.position = "none",
          plot.title = element_text(size = 12))
   

print(pcawg.pathways.plot)

ggsave(plot = pcawg.pathways.plot, 
       filename = file.path(fig.dir, "pcawg_pathways_summary.png"),
      width = 5, height = 6.2) 
```

### Interactions between PCAWG signatures and 10 pathway alterations

```{r path-sig-prep}
PATH_MIN_TISSUES = 30

abundant.tissues = which(PCAWG.full.subset.ann.pathways$Cancer.Types %>% 
                             table() > PATH_MIN_TISSUES) %>% names()
```

#### Interactions between all pathways and signatures

```{r}
all.path.sig.assocs = get_sig_path_assocs(
    PCAWG.full.subset.ann.pathways %>% select(4:ncol(.)),
    mutated.pathways.tissues %>% select(4:ncol(.)),
    p.val.threshold = 0.05)

all.path.sig.heatmap = ggheatmap::ggheatmap(
    dataMatrix = rm_zeros(all.path.sig.assocs), 
    points = T, revColors = F, revRow = T, 
    scaleName = "log(OR)",
    colorPalette = "RdBu",
    limits = c(-5, 5))

all.path.sig.heatmap

ggsave(plot = all.path.sig.heatmap,
       file = file.path(fig.dir, "all.path.sig.heatmap.png"),
       width = 5, height = 6)
```

#### Fisher's exact test between signatures and pathways in individual tissues

```{r, warning = FALSE}
tissue.odds.ratio = pcawg_sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = mutated.pathways.tissues,
                                 interaction_function = get_sig_path_assocs, 
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.1,
                                 p.adjust = TRUE,
                                 method = "BH")

for (tissue in names(tissue.odds.ratio)) {
   
    if (any(abs(tissue.odds.ratio[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.odds.ratio[[tissue]], 
                                        title = tissue)
        
        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "by_tissues", "oddsratio",  
                                    paste0(tissue, "_sig_pathway.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}
```

### Linear regression predicting signatures from pathways across tissues

I tried logging the signatures before the linear regression or using raw counts.
In this first case, I tried logging. 


```{r, warning = FALSE}
tissue.lm.coefs.mats.log = pcawg_sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = mutated.pathways.tissues,
                                 interaction_function = get_sig_path_lms, 
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.1,
                                 p.adjust = TRUE,
                                 method = "BH",
                                 sig.log = TRUE,
                                 path.to.sig = TRUE)
 
for (tissue in abundant.tissues) {
   
    if (any(abs(tissue.lm.coefs.mats.log[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.lm.coefs.mats.log[[tissue]], 
                                        title = tissue)
        
        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "pathway_to_signature",
                                    "by_tissues", "lm_log", 
                                    paste0(tissue, "_sig_tilde_pathway.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}
```

In the example below I'm trying with raw counts.

```{r, warning = FALSE}
tissue.lm.coefs.mats = pcawg_sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = mutated.pathways.tissues,
                                 interaction_function = get_sig_path_lms, 
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.05,
                                 p.adjust = TRUE,
                                 method = "BH",
                                 sig.log = FALSE)
    

for (tissue in abundant.tissues) {
   
    if (any(abs(tissue.lm.coefs.mats[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.lm.coefs.mats[[tissue]], 
                                        title = tissue)
        
        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "by_tissues", "lm_counts", 
                                    paste0(tissue, "_sig_tilde_pathway.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}
```

#### Summarizing the regression of signatures ~ pathways

```{r}
pp.logged = plot_all_counts(tissue.lm.coefs.mats.log, threshold = 0.2)
print(pp.logged)

ggsave(plot = pp.logged,
               filename = file.path(fig.dir, "pathway_to_signature", 
                                    "by_tissues", "lm_log", 
                                    "logged_summarized.png"),
               height = 3, width = 4, bg = "white")
```


```{r}
pp.counts = plot_all_counts(tissue.lm.coefs.mats, threshold = 0.2)
# print(pp.counts)

ggsave(plot = pp.counts,
               filename = file.path(fig.dir, "pathway_to_signature", 
                                    "by_tissues", "lm_counts", 
                                    "counts_summarized.png"),
               height = 3, width = 4, bg = "white")
```

### Logistic regression predicting pathways from signatures across tissues

```{r}
tissue.log.coefs.mats.log = pcawg_sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = mutated.pathways.tissues,
                                 interaction_function = get_sig_path_lms, 
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.1,
                                 p.adjust = TRUE,
                                 method = "BH",
                                 sig.log = TRUE,
                                 robust = TRUE,
                                 path.to.sig = FALSE)
 
   
for (tissue in abundant.tissues) {
    if (any(abs(tissue.log.coefs.mats.log[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.log.coefs.mats.log[[tissue]], 
                                        title = tissue)
        
        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "signature_to_pathway", 
                                    "by_tissues", "log_log", 
                                    paste0(tissue, "_path_tilde_sig.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}

```

#### Summarizing the regression of pathways ~ signatures

```{r}
pp.logged = plot_all_counts(tissue.log.coefs.mats.log, threshold = 0.1)
print(pp.logged)

ggsave(plot = pp.logged,
               filename = file.path(fig.dir, "signature_to_pathway", 
                                    "by_tissues", "log_log", 
                                    "logged_summarized.png"),
               height = 1.1, width = 1.2, bg = "white")
```
