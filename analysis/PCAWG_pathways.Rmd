---
title: "Signalling pathways in PCAWG"
output:
  html_document:
    df_print: paged
---

```{r}
knitr::opts_chunk$set(comment = '', fig.width = 6, 
                      fig.height = 6, echo = FALSE, 
                      warning = FALSE)
```


```{r load-packages, message=FALSE}
library(here)
library("cowplot")
fig.dir = here("figures/pathways_analysis")

if(! file.exists(fig.dir)){
    dir.create(fig.dir, recursive = TRUE)
}

out.dir = here("data", "RDS", "PCAWG", "10_onco_pathways")

source(here("R/load_packages.R"))
```

```{r loading}
PCAWG.pathways.tissues = readRDS(file = here("data/RDS/PCAWG/10_onco_pathways",
                                              "pcawg_pathways.RDS"))

PCAWG.full.subset.ann.pathways = readRDS(file = here("data/RDS/PCAWG/10_onco_pathways",
                                              "PCAWG.full.subset.ann.pathways.RDS"))

PCAWG.full.subset.ann = readRDS(here("data", "RDS", "PCAWG", "signatures",
                                     "PCAWG.full.subset.ann.RDS"))

PCAWG.active.sig.counts = data.frame(Tissues = PCAWG.full.subset.ann$Cancer.Types,
                                      active.sig.counts = rowSums(PCAWG.full.subset.ann[4:ncol(PCAWG.full.subset.ann)] > 0))
```

### Getting the quantiles 

```{r}
get_quants_from_null = function(null.list, sigs, paths, quant.lim) {

    out.list = list()
    
    for (tissue in names(null.list)) {
        
        
        tissue.elems = get_tissue_pathway_activities(tissue, sigs, paths)
        
        zero.mat = matrix(0, ncol = ncol(tissue.elems$paths),
                          nrow = ncol(tissue.elems$sigs),
                          dimnames = list(colnames(tissue.elems$sigs), 
                                          sub("-", ".", sub(" ", ".", colnames(tissue.elems$paths) ) ) ) )
        
        quantiles.mat = do.call(rbind, 
                                lapply(null.list[[tissue]], function(x) {
                                    if(length(x) == 0) {
                                        return(as.vector(zero.mat))
                                    } else {
                                        out = zero.mat
                                        out[rownames(x),colnames(x)] = out[rownames(x),colnames(x)] +
                                            as.matrix(x)
                                        return(as.vector(unlist(out)))
                                    }
                                    
                                }
                                ) )
        quants = apply(quantiles.mat, MARGIN = 2, function(x)
            quantile(abs(x), probs = quant.lim))    
        
        out = zero.mat + matrix(quants, nrow = nrow(zero.mat), ncol = ncol(zero.mat))
        
        out.list[[tissue]] = out
    }
    return(out.list)
}

```


### PCAWG summary statistics about available data

In total we have `r nrow(PCAWG.pathways.tissues)` samples and 
`r unique(PCAWG.pathways.tissues$Cancer.Types) %>% length()` tissues.

```{r}
# [1] 1552
PCAWG.mutated.pathways.occ.plot = PCAWG.pathways.tissues %>% 
    mutate(across (`Cell Cycle`:Telomeric, ~ . > 0)) %>% 
    rowwise() %>% 
    mutate(sum.mut.paths = sum(c_across(`Cell Cycle`:Telomeric))) %>% 
    ggplot(aes(x = sum.mut.paths, fill = Cancer.Types) ) + 
    geom_histogram(binwidth = 1, color = "gray90") +
    facet_wrap(~Cancer.Types) +
        theme_classic(base_size = 13) + 
        scale_x_continuous(breaks = seq(1, 7)) + 
        coord_cartesian(expand = FALSE) + 
        scale_fill_manual(values = scales::muted(
            rainbow(PCAWG.active.sig.counts %>% pull(Tissues) %>% 
                        n_distinct()), l = 50, c = 90 ), guide = "none" ) +
        xlab("Mutated pathways") + ylab("Number of samples") + 
    theme(strip.text.x = element_text(size = 6))


ggsave(file = file.path(fig.dir, "PCAWG.mutated.pathways.occurrence.pdf"),
       plot = PCAWG.mutated.pathways.occ.plot, 
       width = 5, height = 5)
```


### Heatmap of cancer types and pathways

```{r pathway-summary-heatmap}
pathway.summaries.by.tissues = PCAWG.pathways.tissues %>% 
    mutate(across(`Cell Cycle`:Telomeric, ~as.numeric(.x > 0))) %>% 
    group_by(Cancer.Types) %>% 
    summarize(across(`Cell Cycle`:Telomeric, ~ sum(.x, na.rm = TRUE)))

pcawg.pathway.summaries.gg = pathway.summaries.by.tissues  %>% 
    gather("Pathway", "Activity", -Cancer.Types) %>% 
    group_by(Cancer.Types, Pathway) %>% 
    summarise(total = sum(Activity))

path.order = pcawg.pathway.summaries.gg %>% 
    dplyr::select(Pathway, total) %>% 
    group_by(Pathway) %>% 
    summarise(ss = sum(total)) %>% 
    arrange(desc(ss)) %>% 
    pull(Pathway)

pcawg.pathways.plot = pcawg.pathway.summaries.gg %>% rename(Counts = total) %>% 
    mutate(Pathway = factor(Pathway, levels = path.order)) %>% 
    
    ggplot(aes(x = Pathway, y = Cancer.Types) ) + 
        geom_tile(aes(fill = Counts), color = "gray80") +
        geom_text(aes(label = Counts), size = 3.4) + 
    #scale_fill_viridis(option = "plasma")
    scale_fill_gradient(low = "aliceblue", high = "orange") + 
    theme_minimal(base_size = 14) + 
    xlab("") + ylab("") + 
    ggtitle("Pathway alterations across cancer types: PCAWG",) +
    theme(panel.grid = element_blank(),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          legend.position = "none",
          plot.title = element_text(size = 12))
   

print(pcawg.pathways.plot)

ggsave(plot = pcawg.pathways.plot, 
       filename = file.path(fig.dir, "pcawg_pathways_summary.png"),
      width = 5, height = 6.2) 

ggsave(plot = pcawg.pathways.plot, 
       filename = file.path(fig.dir, "pcawg_pathways_summary.pdf"),
      width = 5, height = 6.2) 

```

### Interactions between PCAWG signatures and 10 pathway alterations

```{r path-sig-prep}
PATH_MIN_TISSUES = 30

abundant.tissues = which(PCAWG.full.subset.ann.pathways$Cancer.Types %>% 
                             table() > PATH_MIN_TISSUES) %>% names()

# number of total samples
# PCAWG.full.subset.ann.pathways$Cancer.Types %in% abundant.tissues %>% sum()
```


#### Interactions between all pathways and signatures

```{r}
all.path.sig.assocs = get_sig_path_assocs(
    PCAWG.full.subset.ann.pathways %>% dplyr::select(4:ncol(.)),
    PCAWG.pathways.tissues %>% dplyr::select(4:ncol(.)),
    p.val.threshold = 0.05)

all.path.sig.heatmap = myggheatmap(
    dataMatrix = rm_zeros(all.path.sig.assocs), 
    points = T, revColors = F, revRow = T, 
    scaleName = "log(OR)",
    colorPalette = "RdBu",
    limits = c(-5, 5))

all.path.sig.heatmap

ggsave(plot = all.path.sig.heatmap,
       file = file.path(fig.dir, "PCAWG.all.path.sig.heatmap.png"),
       width = 5, height = 6)
```

### Creating a signature-pathway matrix for GES in octave

```{r}
tissue = "Skin_Melanoma"

tissue.sigs.mat = subset_tissue(PCAWG.full.subset.ann.pathways, tissue) %>% 
    select(4:ncol(.))

tissue.sigs.mat = tissue.sigs.mat[,colSums(tissue.sigs.mat > 0) > 10]

tissue.path.mat = subset_tissue(PCAWG.pathways.tissues, tissue = tissue) %>% 
    select(4:ncol(.))

tissue.path.mat[ tissue.path.mat != 0 ] = 1
tissue.path.mat = tissue.path.mat[, colSums(tissue.path.mat > 0) > 6]

tissue.octave.out = cbind(tissue.sigs.mat, tissue.path.mat)

write_tsv(tissue.octave.out, file = here("data/test/GES_test_melanoma_sig_pathways.tsv"))

```

Reading octave output for melanoma.

```{r}
tissue.octave.adjacency = read.table(here("data/test/GES_melanoma_adjacency.tsv"),
                                     sep = "\t", col.names = colnames(tissue.octave.out),
                                     row.names = colnames(tissue.octave.out))

G = igraph::graph_from_adjacency_matrix(as.matrix(tissue.octave.adjacency))


tbl.G = as_tbl_graph(G, directed = TRUE) %>% 
    activate(nodes) %>% 
    mutate(type = ifelse(name %in% colnames(tissue.sigs.mat), 
                         yes = "signature", no = "pathways")) %>% 
    mutate(node_isolated = node_is_isolated()) %>% 
    filter(!node_isolated)


raw.network = tbl.G  %>% ggraph(layout = "kk") +
    geom_edge_link(arrow = arrow(length = unit(2, units = "mm"), angle = 25),
                   start_cap = circle(3, 'mm'),
                   end_cap = circle(3, 'mm'),
                   color = "grey60") +
    geom_node_point(aes(shape = type), color = "darkblue", size = 3) +
    geom_node_text(aes(label = name), repel = TRUE, force = 60) + 
    theme_void() + ggtitle("Raw signatures")

tissue.logged.octave.adjacency = read.table(here("data/test/GES_melanoma_logged_adjacency.tsv"),
                                     sep = "\t", col.names = colnames(tissue.octave.out),
                                     row.names = colnames(tissue.octave.out))

tbl.logged.G = as_tbl_graph(igraph::graph_from_adjacency_matrix(as.matrix(tissue.octave.adjacency)), directed = TRUE)


logged.network = tbl.logged.G  %>% ggraph(layout = "kk") +
    geom_edge_link(arrow = arrow(length = unit(2, units = "mm"), angle = 25),
                   end_cap = circle(3, 'mm'),
                   color = "grey60") +
    geom_node_point(color = "red") +
    geom_node_text(aes(label = name), repel = TRUE) + 
    theme_void() + ggtitle("Logged signatures")

comp.network =ggarrange(logged.network, raw.network)

```

#### Fisher's exact test between signatures and pathways in individual tissues

```{r, warning = FALSE}
tissue.odds.ratio = sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = PCAWG.pathways.tissues,
                                 interaction_function = get_sig_path_assocs, 
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.1,
                                 p.adjust = TRUE,
                                 method = "BH")

for (tissue in names(tissue.odds.ratio)) {
   
    if (any(abs(tissue.odds.ratio[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.odds.ratio[[tissue]], 
                                        title = tissue)
        
        print(int.heatmap)
        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "pathway_to_signature", "by_tissues", "oddsratio",
                                    paste0("PCAWG_", tissue, "_sig_pathway.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}
```

### Setting the null model for the OR

```{r, echo = FALSE, include=FALSE}
# tissue.odds.ratios.null = sig_pathway_int_null(sigs.input = PCAWG.full.subset.ann.pathways,
#                                  pathways.input = PCAWG.pathways.tissues,
#                                  interaction_function = get_sig_path_assocs, 
#                                  path.min.tissues = 30,
#                                  p.val.threshold = 0.05,
#                                  p.adjust = FALSE,
#                                  method = "BH",
#                                  N = 1000)
# 
# saveRDS(tissue.odds.ratios.null, file = file.path(out.dir, "PCAWG.sig.path.OR.nulls.RDS"))
tissue.odds.ratios.null = readRDS(file = file.path(out.dir, "PCAWG.sig.path.OR.nulls.RDS"))
```

```{r}
quant = 0.95
tissue.OR.quantiles = get_quants_from_null(tissue.odds.ratios.null, 
                                           PCAWG.full.subset.ann.pathways,
                                           PCAWG.pathways.tissues, 
                                           quant)
```


```{r}
tissue.odds.ratio.unadjusted = sig_pathway_int(
    sigs.input = PCAWG.full.subset.ann.pathways,
    pathways.input = PCAWG.pathways.tissues,
    interaction_function = get_sig_path_assocs, 
    path.min.tissues = 30,
    p.val.threshold = 0.05,
    p.adjust = FALSE,
    method = "BH")

tissue.odds.ratio.null.adjusted = setNames(
    lapply(names(tissue.odds.ratio.unadjusted),
           function(tissue) {
               observed = tissue.odds.ratio.unadjusted[[tissue]]
               colnames(observed) = sub("-", ".", sub(" ", ".", colnames(observed) ) )
               nm = tissue.OR.quantiles[[tissue]]
               nm = observed[rownames(observed), colnames(observed)]
               
               observed[abs(observed) < nm] = 0
               return(observed)
           }
    ), names(tissue.odds.ratio.unadjusted) )

for (tissue in names(tissue.odds.ratio.null.adjusted)) {
   
    if (any(abs(tissue.odds.ratio.unadjusted[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.odds.ratio.unadjusted[[tissue]], 
                                        title = tissue)
        
        print(int.heatmap)
        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "pathway_to_signature", "by_tissues", "oddsratio",
                                    paste0("PCAWG_", tissue, "_sig_pathway_null_adjusted.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}
```

```{r}
pp.odds.ratio.null.adjusted = plot_all_counts(tissue.odds.ratio.null.adjusted, 
                                              threshold = 0.2, psize = 5,
                                              expand.mult = c(0.13, 0.13))

ggsave(plot = pp.odds.ratio.unadjusted,
               filename = file.path(fig.dir, "pathway_to_signature", "by_tissues", "oddsratio",
                                    "PCAWG_summarized_sig_pathway_null_adjusted.dotplot.pdf"),
               height = 2.4, width = 3.4, bg = "white", device = cairo_pdf, family = "DejaVu Sans")
```

### Bipartite graph - not used 

```{r}
sig.path.oddsratio.bipartite = minor_plot(plot_bipartite2(tissue.odds.ratio.null.adjusted),
                                        expand.factor = 0.5, expand.factor.y = 0.01)

ggsave(plot = sig.path.oddsratio.bipartite,
       filename = file.path(fig.dir, "pathway_to_signature", "by_tissues", "oddsratio",
                                    "PCAWG_summarized_sig_pathway_unadjusted.bipartite.pdf"),
       height = 5, width = 5.5, bg = "white", device = cairo_pdf, family = "DejaVu Sans")
```

### Tissues of Odds ratio interactions

```{r}
tissues.odds.ratio.lists = get_interaction_tissues(tissue.odds.ratio.null.adjusted)

write.table(as.data.frame(tissues.odds.ratio.lists$pos.tissues), 
          file = here("supp_data", "PCAWG_sig_pathway_positive_interaction_tissue_summaries.tsv"),
          row.names = TRUE, col.names = NA, sep = "\t", quote = FALSE)
write.table(as.data.frame(tissues.odds.ratio.lists$neg.tissues), 
          file = here("supp_data", "PCAWG_sig_pathway_negative_interaction_tissue_summaries.tsv"),
          row.names = TRUE, col.names = NA, sep = "\t", quote = FALSE)

```


### Linear regression predicting signatures from pathways across tissues

I tried logging the signatures before the linear regression or using raw counts.
In this first case, I tried logging.


```{r, warning = FALSE}
tissue.lm.coefs.mats.log = sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = PCAWG.pathways.tissues,
                                 interaction_function = get_sig_path_lms,
                                 robust = FALSE,
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.05,
                                 p.adjust = FALSE,
                                 method = "BH",
                                 sig.log = TRUE,
                                 path.to.sig = TRUE)
```

### Setting the null model for the LM for sig ~ path

```{r, echo = FALSE, include=FALSE}
# tissue.lm.ratios.null = sig_pathway_int_null(sigs.input = PCAWG.full.subset.ann.pathways,
#                                  pathways.input = PCAWG.pathways.tissues,
#                                  interaction_function = get_sig_path_lms, 
#                                  robust = FALSE,
#                                  path.min.tissues = 30,
#                                  p.val.threshold = 0.05,
#                                  p.adjust = FALSE,
#                                  method = "BH",
#                                  sig.log = TRUE,
#                                  path.to.sig = TRUE,
#                                  N = 1000)
# 
# saveRDS(tissue.lm.ratios.null, file = file.path(out.dir, "PCAWG.sig.path.lm.nulls.RDS"))
tissue.lm.ratios.null = readRDS(file = file.path(out.dir, "PCAWG.sig.path.lm.nulls.RDS"))
```

```{r}
quant = 0.95
tissue.lm.quantiles = get_quants_from_null(tissue.lm.ratios.null,
                                           PCAWG.full.subset.ann.pathways,
                                           PCAWG.pathways.tissues, 
                                           quant)
```

### Applying the filter

```{r}
tissue.lm.null.adjusted = setNames(
    lapply(names(tissue.lm.coefs.mats.log),
           function(tissue) {
               observed = tissue.lm.coefs.mats.log[[tissue]]
               colnames(observed) = sub("-", ".", sub(" ", ".", colnames(observed) ) )
               nm = tissue.lm.quantiles[[tissue]]
               nm = observed[rownames(observed), colnames(observed)]
               
               observed[abs(observed) < nm] = 0
               return(observed)
           }
    ), names(tissue.lm.coefs.mats.log) )
```


```{r}
for (tissue in abundant.tissues) {
    cat(tissue, "\n")
    if (any(abs(tissue.lm.null.adjusted[[tissue]]) > 0) ) {
        int.heatmap = ggheatmap_wrapper(tissue.lm.null.adjusted[[tissue]],
                                        title = tissue)

        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "pathway_to_signature",
                                    "by_tissues", "lm_log",
                                    paste0("PCAWG_", tissue, "_sig_tilde_pathway.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}
```

<!-- In the example below I'm trying with raw counts. -->

<!-- ```{r, warning = FALSE} -->
<!-- tissue.lm.coefs.mats = sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways, -->
<!--                                  pathways.input = PCAWG.pathways.tissues, -->
<!--                                  interaction_function = get_sig_path_lms,  -->
<!--                                  robust = FALSE, -->
<!--                                  path.min.tissues = 30, -->
<!--                                  p.val.threshold = 0.05, -->
<!--                                  p.adjust = TRUE, -->
<!--                                  method = "BH", -->
<!--                                  sig.log = FALSE) -->


<!-- for (tissue in abundant.tissues) { -->

<!--     if (any(abs(tissue.lm.coefs.mats[[tissue]]) > 0) ) { -->
<!--         cat(tissue, "\n") -->
<!--         int.heatmap = ggheatmap_wrapper(tissue.lm.coefs.mats[[tissue]],  -->
<!--                                         title = tissue) -->

<!--         ggsave(plot = int.heatmap, -->
<!--                filename = file.path(fig.dir,"pathway_to_signature", "by_tissues", "lm_counts",  -->
<!--                                     paste0("PCAWG_", tissue, "_sig_tilde_pathway.dotplot.png")), -->
<!--                height = 5, width = 6, bg = "white") -->
<!--     } -->
<!-- } -->
<!-- ``` -->

#### Summarizing the regression of signatures ~ pathways

```{r, fig.width=6, fig.height=4, warning= FALSE}
pp.logged = plot_all_counts(tissue.lm.null.adjusted, threshold = 0.2, psize = 4.5,
                            expand.mult = c(0.03, 0.03))
print(pp.logged)

# ggsave(plot = pp.logged,
#                filename = file.path(fig.dir, "pathway_to_signature",
#                                     "by_tissues", "lm_log",
#                                     "PCAWG_logged_summarized_OLS.png"),
#                height = 2.3, width = 2.9, bg = "white")

ggsave(plot = pp.logged,
               filename = file.path(fig.dir, "pathway_to_signature",
                                    "by_tissues", "lm_log", "PCAWG_logged_summarized_OLS_path_to_sigs.pdf"),
               height = 2.7, width = 4.4, bg = "white", device = cairo_pdf, family = "DejaVu Sans")

```


### Case inspection of melanoma

```{r}
tissue = "Skin_Melanoma"
skin.data = get_tissue_pathway_activities(tissue,
                                          sigs.input = PCAWG.full.subset.ann.pathways,
                                          pathways.input = PCAWG.pathways.tissues)

skin.data$sigs.logged = skin.data$sigs %>%
    mutate(across(.cols = everything(), ~ log(.x + 1 )))

skin.concat = merge(skin.data$sigs.logged, skin.data$paths, by = "row.names")

uv.rtkras = skin.concat %>%
    mutate (`RTK RAS` = factor(`RTK RAS`, levels = c(0, 1,2,3))) %>%
    ggplot(aes(x = `RTK RAS`, y = UV,
                           group = `RTK RAS`, fill = `RTK RAS`) ) +
    geom_boxplot(width = 0.6) + geom_jitter(width = 0.15, height = 0.15, size = 0.5) +
    theme_bw(base_size = 13) +
    ylab("log(UV)") + coord_flip()


# uv.rtkras = skin.concat %>%
#     mutate (`RTK RAS` = factor(`RTK RAS`, levels = c(0, 1,2,3))) %>%
#     ggplot(aes(x = `RTK RAS`, y = UV,
#                            group = `RTK RAS`, fill = `RTK RAS`) ) +
#     geom_violin() + geom_jitter(width = 0.15, height = 0.15, size = 0.5) +
#     theme_bw(base_size = 13) +
#     ylab("log(UV)") + coord_flip()


print(uv.rtkras)

ggsave(filename = file.path(fig.dir, paste0(tissue, "PCAWG_uv_rtkras_relationship.pdf")),
       plot = uv.rtkras, width = 4, height = 2)


rev.uv.rtkras = skin.concat %>%
    mutate (`RTK RAS` = factor(`RTK RAS`, levels = c(0, 1,2,3))) %>%
    ggplot(aes(x = UV, y = `RTK RAS`) ) +
    geom_jitter(width = 0.1, height = 0.15) +
    theme_bw(base_size = 13) +
    xlab("log(UV)")

ggsave(filename = file.path(fig.dir, paste0(tissue, "rev_uv_rtkras_relationship.png")),
       plot = rev.uv.rtkras, width = 4, height = 3.2)
```


<!-- ```{r} -->
<!-- skin.hippo.apo = skin.concat %>%  -->
<!--     ggplot(aes(x = factor(HIPPO), y = APOBEC,  -->
<!--                             fill = factor(HIPPO) ) ) + -->
<!--     theme_bw(base_size = 13) + -->
<!--     geom_boxplot(outlier.shape = NA) +  -->
<!--     geom_jitter(width = 0.2, height = 0.02) + -->
<!--     geom_smooth(aes(group = 1),  -->
<!--                     data = skin.concat, method = lm, se = FALSE) -->

<!-- ggsave(filename = file.path(fig.dir, paste0(tissue, "_apobec_hippo_relationship.png")),  -->
<!--        plot = skin.hippo.apo, width = 4, height = 3.2) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- skin.hippo.apo.rev = skin.concat %>%  -->
<!--     ggplot(aes(x = APOBEC, y = HIPPO)) + -->
<!--     theme_classic() +  -->
<!--     scale_x_continuous(expand = c(0.2, 0.2)) +  -->
<!--     geom_smooth(method = "glm",  -->
<!--     method.args = list(family = "binomial"),  -->
<!--     se = FALSE) + geom_jitter(aes(color = factor(HIPPO)), width = 0.1, height = 0.1) -->

<!-- ggsave(filename = file.path(fig.dir, paste0(tissue, "_apobec_hippo_rev_relationship_logistic.png")),  -->
<!--        plot = skin.hippo.apo.rev, width = 4, height = 3.2) -->
<!-- ``` -->




### Logistic regression predicting pathways from signatures across tissues

```{r}
tissue.log.coefs.mats.log = sig_pathway_int(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = PCAWG.pathways.tissues,
                                 interaction_function = get_sig_path_lms,
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.05,
                                 p.adjust = FALSE,
                                 method = "BH",
                                 sig.log = TRUE,
                                 robust = FALSE,
                                 path.to.sig = FALSE)

```

### Null model for glm(pathway ~ signature)


```{r, echo = FALSE, include=FALSE, warning = FALSE}
tissue.glm.ratios.null = sig_pathway_int_null(sigs.input = PCAWG.full.subset.ann.pathways,
                                 pathways.input = PCAWG.pathways.tissues,
                                 interaction_function = get_sig_path_lms,
                                 path.min.tissues = 30,
                                 p.val.threshold = 0.05,
                                 p.adjust = FALSE,
                                 method = "BH",
                                 sig.log = TRUE,
                                 robust = FALSE,
                                 path.to.sig = FALSE,
                                 N = 1000)

saveRDS(tissue.glm.ratios.null, file = file.path(out.dir, "PCAWG.sig.path.glm.nulls.RDS"))
tissue.glm.ratios.null = readRDS(file = file.path(out.dir, "PCAWG.sig.path.glm.nulls.RDS"))
```

```{r}
quant = 0.95
tissue.glm.quantiles = get_quants_from_null(tissue.glm.ratios.null,
                                           PCAWG.full.subset.ann.pathways,
                                           PCAWG.pathways.tissues, 
                                           quant)
```


```{r}
tissue.glm.null.adjusted = setNames(
    lapply(names(tissue.log.coefs.mats.log),
           function(tissue) {
               observed = tissue.log.coefs.mats.log[[tissue]]
               colnames(observed) = sub("-", ".", sub(" ", ".", colnames(observed) ) )
               nm = tissue.glm.ratios.null[[tissue]]
               nm = observed[rownames(observed), colnames(observed)]
               
               observed[abs(observed) < nm] = 0
               return(observed)
           }
    ), names(tissue.log.coefs.mats.log) )
```


```{r}
for (tissue in abundant.tissues) {
    if (any(abs(tissue.glm.null.adjusted[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.log.coefs.mats.log[[tissue]],
                                        title = tissue)

        ggsave(plot = int.heatmap,
               filename = file.path(fig.dir, "signature_to_pathway",
                                    "by_tissues", "log_log",
                                    paste0("PCAWG_", tissue, "_path_tilde_sig.glm.null.adjusted.dotplot.png")),
               height = 5, width = 6, bg = "white")
    }
}

```

#### Summarizing the regression of pathways ~ signatures

```{r}
pp.log.log = plot_all_counts(tissue.glm.null.adjusted, threshold = 0.1, psize = 5,
                             expand.mult = c(0.05, 0.05))
print(pp.log.log)

ggsave(plot = pp.log.log,
               filename = file.path(fig.dir, "signature_to_pathway",
                                    "by_tissues", "log_log",
                                    "PCAWG_logged_glm_null_adjusted_summarized.png"),
               height = 1.15, width = 1.6, bg = "white")
```


### Three summaries together

```{r}
pp.PCAWG.combined.summaries = ggarrange(pp.odds.ratio.null.adjusted + ggtitle("Co-occurrence"), 
          pp.logged + ggtitle("lm(signature ~ pathway)"), 
          pp.log.log + ggtitle("glm(pathway ~ signature)"), 
          # widths = c(0.5, 0.7, 12),
          heights = c(1, 0.9, 1),
          nrow = 3)

pp.PCAWG.combined.summaries = annotate_figure(
    pp.PCAWG.combined.summaries, top = text_grob("PCAWG signature-pathway analysis summaries", 
               color = "black", face = "bold", size = 11))

ggsave(plot = pp.PCAWG.combined.summaries,
               filename = file.path(fig.dir, "PCAWG_combined_summaries_sig_pathway.pdf"),
               height = 10, width = 4, bg = "white", device = cairo_pdf, family = "DejaVu Sans")
```


```{r}

pp.PCAWG.combined.summaries = ggdraw() +
  draw_plot(pp.odds.ratio.unadjusted + ggtitle("Co-occurrence"), x = 0, y = 0.61, width = 1, height = .4) +
  draw_plot(pp.logged + ggtitle("lm(signature ~ pathway)"), x = 0, y = .22, width = 1, height = .4) +
  draw_plot(pp.log.log + ggtitle("glm(pathway ~ signature)"), x = 0, y = 0, width = 0.42, height = 0.22) 

ggsave(plot = pp.PCAWG.combined.summaries,
               filename = file.path(fig.dir, "PCAWG_combined_summaries_sig_pathway.pdf"),
               height = 10, width = 4, bg = "white", device = cairo_pdf, family = "DejaVu Sans")
```


### All signatures and pathway mutation heatmaps

```{r}
plotlist = list()
for (tissue in abundant.tissues) {
    path.heatmap = pathways_signatures_heatmap(
        tissue = tissue,
        signatures = PCAWG.full.subset.ann.pathways, border_color = NA,
        pathways = PCAWG.pathways.tissues, main = tissue)
    
    if (any(abs(tissue.odds.ratio.unadjusted[[tissue]]) > 0) ) {
        cat(tissue, "\n")
        int.heatmap = ggheatmap_wrapper(tissue.odds.ratio.unadjusted[[tissue]], 
                                        title = tissue)
    } else {
        int.heatmap = grob()
    }
    combined.out = ggarrange(path.heatmap[[4]], int.heatmap, widths = c(1, 1))
    plotlist[[tissue]] = combined.out
}


pdf(file.path(fig.dir, "PCAWG_pathways_signatures_heatmaps.pdf"),
    width = 10, height = 4)
for (tissue in names(plotlist)) {
    print(plotlist[[tissue]])
}
dev.off()
```

### Melanoma pathways

```{r}
tissue = "Skin_Melanoma"
skin.annotated.heatmap = pathways_signatures_heatmap(
        tissue = tissue,
        signatures = PCAWG.full.subset.ann.pathways, border_color = NA,
        pathways = PCAWG.pathways.tissues, main = paste0(tissue, " - PCAWG")) %>% 
    add_pheatmap_legend_title
    

ggsave(plot = skin.annotated.heatmap,
       file = file.path(fig.dir, "PCAWG.skin.annotated.heatmap.pdf"),
       width = 4.5, height = 4)

 int.heatmap = ggheatmap_wrapper(tissue.odds.ratio.unadjusted[[tissue]], 
                                        title = tissue)
        
print(int.heatmap)
ggsave(plot = int.heatmap,
       filename = file.path(fig.dir, "pathway_to_signature", "by_tissues", "oddsratio",
                            paste0("PCAWG_", tissue, "_sig_pathway_unadjusted.dotplot.pdf")),
               height = 5, width = 6, bg = "white")
```


```{r}
tissue = "Skin_Melanoma"
tissue.heatmap = subset_tissue(PCAWG.full.subset, tissue = tissue) %>% 
            plot_tissue_heatmap(main = tissue)
```

### Breast_AdenoCA pathways

```{r}
tissue = "Breast_AdenoCA"
skin.annotated.heatmap = pathways_signatures_heatmap(
        tissue = tissue,
        signatures = PCAWG.full.subset.ann.pathways, border_color = NA,
        pathways = PCAWG.pathways.tissues, main = paste0(tissue, " - PCAWG")) %>% 
    add_pheatmap_legend_title
    

ggsave(plot = skin.annotated.heatmap,
       file = file.path(fig.dir, paste0("PCAWG.", tissue, ".annotated.heatmap.pdf")),
       width = 4.5, height = 4)
```


